<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:url" content="https://whiley.org/2012/05/28/illustrating-compile-time-verification-in-whiley/"><title>Whiley
(Illustrating Compile-Time Verification in Whiley)</title><script type=text/javascript src=js/ace.js></script>
<script type=text/javascript src=js/mode-whiley.js></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://whiley.org/css/page.css><link rel=stylesheet href=https://whiley.org/css/menu.css><link rel=stylesheet href=https://whiley.org/css/style.css><link rel=stylesheet href=https://whiley.org/css/syntax.css></head><body><script>"use strict";function clearMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display="none",t.style.filter="")}function toggleMenu(){var e,t,n=window.matchMedia("(max-width: 992px)");n.matches&&(e=document.getElementById("menu-content"),t=document.getElementById("menu"),e.style.display==="block"?(e.style.display="none",t.style.filter=""):(e.style.display="block",t.style.filter="brightness(0.8)"))}function toggleList(e){e.style.display="none";for(var t,o=e.parentNode,s=o.childNodes,n=0;n<s.length;++n)t=s[n],t.classList&&t.classList.contains("hidden")&&(t.style.display==="block"?t.style.display="none":t.style.display="block")}</script><div class=page><header class=topbar><div class=topbar-title><a href=https://whiley.org/><div class=logo>Wy</div></a></div><div class=topbar-sep></div><div class=topbar-menu><div id=menu onclick=toggleMenu()><div id=menu-icon><img src=https://whiley.org/images/menu.png alt=Menu></div><div id=menu-content><a href=https://whiley.org/news/>News</a>
<a href=https://whiley.org/install/>Install</a>
<a href=https://whiley.org/learn/>Learn</a>
<a href=http://whileylabs.com>Playground</a></div></div></div></header><div class=container><div class=content><div class=section><div class=column><h1>Illustrating Compile-Time Verification in Whiley</h1><div class=post-date>Monday, May
28th,
2012</div><hr><p>With the <a href=http://whiley.org/2012/05/25/whiley-v0-3-15-released/>latest release of Whiley</a>, compile-time checking of constraints can be enabled with a command-line switch.  So, I thought a few examples of this were in order.</p><h2 id=example-absolute-of-an-integer>Example: Absolute of an Integer</h2><p>Consider this simple program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=kd>type</span> <span class=n>nat</span> <span class=k>is</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=k>where</span> <span class=n>x</span> <span class=o>&gt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=n>abs</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>nat</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span>
</span></span></code></pre></div><p>This defines a type <code>nat</code> which is an <code>int</code> whose values are non-negative.  The function abs<code>(int)</code> accepts an <code>int</code> and returns a <code>nat</code>.  However, it contains a bug because <code>int</code> does not subtype <code>nat</code> (since <code>int</code> includes negatives whilst <code>nat</code> does not).  We can compile this on the command-line like so:</p><pre tabindex=0><code class=language-% data-lang=%>./example.whiley:4: constraint not satisfied
    return x
    ^^^^^^^^
</code></pre><p>The command-line switch <code>-X verification:enable=true</code> turns on compile-time verification. This is not enabled by default because it is experimental. As we can see, the compiler has correctly spotted the error on line 4. We can fix the code like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=kd>type</span> <span class=n>nat</span> <span class=k>is</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=k>where</span> <span class=n>x</span> <span class=o>&gt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=n>abs</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>nat</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=o>&gt;=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=n>x</span>
</span></span></code></pre></div><p>This will now compile correctly with verification enabled.  As you can see the verifier is able to correctly reason about the effect of conditional statements.</p><h2 id=example-maximum-of-two-integers>Example: Maximum of two Integers</h2><p>As another illustration, consider the following (broken) implementation of the <code>max(int,int)</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=kd>function</span> <span class=n>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kt>int</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>y</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>At this point, the function does the <em>opposite</em> of what you would expect (i.e. it computes the minimum of <code>x</code> and <code>y</code> because of a bug). However, the function will compile with verification enabled because the code meets the given specification. Let us improve the specification a little by introducing some constraints:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=kd>function</span> <span class=n>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=kt>int</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=n>r</span> <span class=o>==</span> <span class=n>x</span> <span class=o>||</span> <span class=n>r</span> <span class=o>==</span> <span class=n>y</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>y</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>The given constraint states the return value <code>r</code> is equal to either <code>x</code> or <code>y</code>. However, this constraint is not strong enough to enforce that the maximum of <code>x</code> and <code>y</code> is returned. Hence, the code still compiles even with verification enabled. Finally, we add the missing bit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-whiley data-lang=whiley><span class=line><span class=cl><span class=kd>function</span> <span class=n>max</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=kt>int</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>ensures</span> <span class=p>(</span><span class=n>r</span> <span class=o>==</span> <span class=n>x</span> <span class=o>||</span> <span class=n>r</span> <span class=o>==</span> <span class=n>y</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>x</span> <span class=o>&lt;=</span> <span class=n>r</span> <span class=o>&amp;&amp;</span> <span class=n>y</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>y</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y</span>
</span></span></code></pre></div><p>Compiling the above with verification enabled now gives the following error:</p><pre tabindex=0><code class=language-% data-lang=%>./max.whiley:3: postcondition not satisfied
        return x
        ^^^^^^^^
</code></pre><p>At this point, we can fix the bug by changing the condition to be <code>if x > y</code> and it will compile correctly with verification enabled.</p><hr></div></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-5582165-5","auto"),ga("send","pageview"))</script></body></html>